<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>AR.js - 3D Model once detected</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.138.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r138/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/build/ar-threex.js"></script>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      #startButton {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 20px;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: #222;
        color: white;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <button id="startButton">▶ Start AR</button>
    <script>
      document.getElementById("startButton").addEventListener("click", () => {
        document.getElementById("startButton").style.display = "none";
        startAR();
      });

      function startAR() {
        const scene = new THREE.Scene();
        const camera = new THREE.Camera();
        scene.add(camera);

        const renderer = new THREE.WebGLRenderer({
          antialias: true,
          alpha: true,
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const arSource = new THREEx.ArToolkitSource({ sourceType: "webcam" });
        arSource.init(() => {
          setTimeout(() => {
            arSource.onResizeElement();
            arSource.copyElementSizeTo(renderer.domElement);
          }, 2000);
        });

        window.addEventListener("resize", () => {
          arSource.onResizeElement();
          arSource.copyElementSizeTo(renderer.domElement);
        });

        const arContext = new THREEx.ArToolkitContext({
          cameraParametersUrl: "camera_para.dat",
          detectionMode: "mono",
        });
        arContext.init(() => {
          camera.projectionMatrix.copy(arContext.getProjectionMatrix());
        });

        const markerRoot = new THREE.Group();
        scene.add(markerRoot);

        new THREEx.ArMarkerControls(arContext, markerRoot, {
          type: "pattern",
          patternUrl: "pattern-spider-man-logo.patt",
        });

        // Load GLTF model
        const loader = new THREE.GLTFLoader();
        let model, mixer;
        let modelAdded = false;
        const clock = new THREE.Clock();

        loader.load("Gothic.glb", (gltf) => {
          model = gltf.scene;
          model.scale.set(0.5, 0.5, 0.5);
          model.position.set(0, 0, 0);

          markerRoot.add(model);

          if (gltf.animations && gltf.animations.length > 0) {
            mixer = new THREE.AnimationMixer(model);
            gltf.animations.forEach((clip) => mixer.clipAction(clip).play());
          }
        });

        function animate() {
          requestAnimationFrame(animate);

          if (arSource.ready) {
            arContext.update(arSource.domElement);
          }

          // Khi marker thấy lần đầu → gỡ model ra khỏi marker và thêm trực tiếp vào scene
          if (markerRoot.visible && model && !modelAdded) {
            scene.add(model);
            modelAdded = true;
          }

          if (mixer) mixer.update(clock.getDelta());

          renderer.render(scene, camera);
        }
        animate();
      }
    </script>
  </body>
</html>
