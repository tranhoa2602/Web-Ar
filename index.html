<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AR.js - 3D Model</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Three.js + loaders -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.138.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.138.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.138.0/examples/js/loaders/DRACOLoader.js"></script>

  <!-- AR.js -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/build/ar-threex.js"></script>

  <style>
    html, body { margin:0; overflow:hidden; background:#000; }
    #startButton {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px; padding: 12px 20px;
      border: none; border-radius: 10px;
      background: #222; color: #fff; cursor: pointer; z-index: 5;
      box-shadow: 0 6px 24px rgba(0,0,0,.3);
    }
  </style>
</head>
<body>
  <button id="startButton">▶ Start AR</button>

  <script>
    document.getElementById("startButton").addEventListener("click", async () => {
      try {
        // Xin quyền camera trong user gesture (quan trọng trên mobile)
        await navigator.mediaDevices.getUserMedia({ video: true });
      } catch (e) {
        alert("Không truy cập được camera. Kiểm tra HTTPS/permission.\n" + e);
        return;
      }
      // Bắt đầu AR
      document.getElementById("startButton").style.display = "none";
      startAR();
    });

    function startAR() {
      // Scene / Camera / Renderer
      const scene = new THREE.Scene();
      const camera = new THREE.Camera();
      scene.add(camera);

      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.outputEncoding = THREE.sRGBEncoding;
      document.body.appendChild(renderer.domElement);

      // Lights
      const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.0);
      hemi.position.set(0, 1, 0);
      scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xffffff, 1.2);
      dir.position.set(1, 2, 1);
      scene.add(dir);

      // AR Source
      const arSource = new THREEx.ArToolkitSource({ sourceType: "webcam" });
      arSource.init(() => {
        setTimeout(() => {
          arSource.onResizeElement();
          arSource.copyElementSizeTo(renderer.domElement);
        }, 500);
      });
      window.addEventListener("resize", () => {
        arSource.onResizeElement();
        arSource.copyElementSizeTo(renderer.domElement);
      });

      // AR Context
      const arContext = new THREEx.ArToolkitContext({
        cameraParametersUrl: "camera_para.dat",
        detectionMode: "mono",
      });
      arContext.init(() => {
        camera.projectionMatrix.copy(arContext.getProjectionMatrix());
      });

      // Marker
      const markerRoot = new THREE.Group();
      scene.add(markerRoot);
      new THREEx.ArMarkerControls(arContext, markerRoot, {
        type: "pattern",
        patternUrl: "pattern-spider-man-logo.patt",
      });
      scene.visible = false;

      // Load model
      const loader = new THREE.GLTFLoader();
      const dracoLoader = new THREE.DRACOLoader();
      dracoLoader.setDecoderPath('https://cdn.jsdelivr.net/npm/three@0.138.0/examples/js/libs/draco/');
      loader.setDRACOLoader(dracoLoader);

      let model, mixer;
      const clock = new THREE.Clock();

      loader.load("Gothic.glb", (gltf) => {
        model = gltf.scene;
        fitAndCenterModel(model, 0.8);
        if (gltf.animations.length > 0) {
          mixer = new THREE.AnimationMixer(model);
          gltf.animations.forEach((clip) => mixer.clipAction(clip).play());
        }
        markerRoot.add(model);
      });

      function fitAndCenterModel(object3d, targetSize = 1.0) {
        const box = new THREE.Box3().setFromObject(object3d);
        const size = new THREE.Vector3();
        const center = new THREE.Vector3();
        box.getSize(size);
        box.getCenter(center);
        object3d.position.sub(center);
        const maxDim = Math.max(size.x, size.y, size.z) || 1;
        const scale = targetSize / maxDim;
        object3d.scale.multiplyScalar(scale);
        object3d.position.y += 0.001;
      }

      // Render loop
      (function animate() {
        requestAnimationFrame(animate);
        if (arSource.ready) arContext.update(arSource.domElement);
        scene.visible = markerRoot.visible;
        if (mixer) mixer.update(clock.getDelta());
        renderer.render(scene, camera);
      })();
    }
  </script>
</body>
</html>
